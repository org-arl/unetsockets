!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).unet={})}(this,function(e){"use strict";const t={REQUEST:"REQUEST",AGREE:"AGREE",REFUSE:"REFUSE",FAILURE:"FAILURE",INFORM:"INFORM",CONFIRM:"CONFIRM",DISCONFIRM:"DISCONFIRM",QUERY_IF:"QUERY_IF",NOT_UNDERSTOOD:"NOT_UNDERSTOOD",CFP:"CFP",PROPOSE:"PROPOSE",CANCEL:"CANCEL"};function s(e){return Array.from({length:e},()=>Math.floor(65536*(1+Math.random())).toString(16).substring(1)).join("")}var n="undefined"!=typeof window&&void 0!==window.document,r="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node,i="object"==typeof self&&self.constructor&&"DedicatedWorkerGlobalScope"===self.constructor.name,o="undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&"userAgent"in navigator&&"string"==typeof navigator.userAgent&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"));"undefined"!=typeof Deno&&void 0!==Deno.version&&Deno.version.deno,"undefined"!=typeof process&&null!=process.versions&&process.versions.bun;const a="open",l="opening";var c;class h{constructor(e={}){let t=e.hostname||"localhost",s=e.port||1100;this._keepAlive=e.keepAlive,this._reconnectTime=e.reconnectTime||5e3,this.url=new URL("tcp://localhost"),this.url.hostname=t,this.url.port=s.toString(),this._buf="",this._firstConn=!0,this._firstReConn=!0,this.pendingOnOpen=[],this.connListeners=[],this.debug=!1,this._sockInit(t,s)}_sendConnEvent(e){this.connListeners.forEach(t=>{t&&"[object Function]"==={}.toString.call(t)&&t(e)})}_sockInit(e,t){if(c)this._sockSetup(e,t);else try{import("net").then(s=>{c=s.createConnection,this._sockSetup(e,t)})}catch(e){this.debug&&console.log("Unable to import net module")}}_sockSetup(e,t){if(c)try{this.sock=c({host:e,port:t}),this.sock.setEncoding("utf8"),this.sock.on("connect",this._onSockOpen.bind(this)),this.sock.on("error",this._sockReconnect.bind(this)),this.sock.on("close",()=>{this._sendConnEvent(!1)}),this.sock.send=e=>{this.sock.write(e)}}catch(e){return void(this.debug&&console.log("Connection failed to ",this.sock.host+":"+this.sock.port))}}_sockReconnect(){!this._firstConn&&this._keepAlive&&this.sock.readyState!=l&&this.sock.readyState!=a&&(this._firstReConn&&this._sendConnEvent(!1),this._firstReConn=!1,setTimeout(()=>{this.pendingOnOpen=[],this._sockSetup(this.url.hostname,this.url.port)},this._reconnectTime))}_onSockOpen(){this._sendConnEvent(!0),this._firstConn=!1,this.sock.on("close",this._sockReconnect.bind(this)),this.sock.on("data",this._processSockData.bind(this)),this.pendingOnOpen.forEach(e=>e()),this.pendingOnOpen.length=0,this._buf=""}_processSockData(e){this._buf+=e;var t=this._buf.split("\n");t.forEach((e,s)=>{s<t.length-1?e&&this._onSockRx&&this._onSockRx.call(this,e):this._buf=e})}toString(){let e="";return e+=(this.sock,this.sock.remoteAddress.toString()+":"+this.sock.remotePort.toString()),e}write(e){return this.sock&&this.sock.readyState!=l?this.sock.readyState==a&&(this.sock.send(e+"\n"),!0):(this.pendingOnOpen.push(()=>{this.sock.send(e+"\n")}),!0)}setReadCallback(e){e&&"[object Function]"==={}.toString.call(e)&&(this._onSockRx=e)}addConnectionListener(e){this.connListeners.push(e)}removeConnectionListener(e){let t=this.connListeners.indexOf(e);return t>=0&&(this.connListeners.splice(t,1),!0)}close(){this.sock&&(this.sock.readyState==l?this.pendingOnOpen.push(()=>{this.sock.send('{"alive": false}\n'),this.sock.removeAllListeners("connect"),this.sock.removeAllListeners("error"),this.sock.removeAllListeners("close"),this.sock.destroy()}):this.sock.readyState==a&&(this.sock.send('{"alive": false}\n'),this.sock.removeAllListeners("connect"),this.sock.removeAllListeners("error"),this.sock.removeAllListeners("close"),this.sock.destroy()))}}class u{constructor(e={}){let t=e.hostname||"localhost",s=e.port||80;this.url=new URL("ws://localhost"),this.url.hostname=t,this.url.port=s.toString(),this.url.pathname=e.pathname||"/",this._keepAlive=e.keepAlive,this._reconnectTime=e.reconnectTime||5e3,this.debug=e.debug||!1,this._firstConn=!0,this._firstReConn=!0,this.pendingOnOpen=[],this.connListeners=[],this._websockSetup(this.url)}_sendConnEvent(e){this.connListeners.forEach(t=>{t&&"[object Function]"==={}.toString.call(t)&&t(e)})}_websockSetup(e){try{this.sock=new WebSocket(e),this.sock.onerror=this._websockReconnect.bind(this),this.sock.onopen=this._onWebsockOpen.bind(this),this.sock.onclose=()=>{this._sendConnEvent(!1)}}catch(t){return void(this.debug&&console.log("Connection failed to ",e))}}_websockReconnect(){!this._firstConn&&this._keepAlive&&this.sock.readyState!=this.sock.CONNECTING&&this.sock.readyState!=this.sock.OPEN&&(this._firstReConn&&this._sendConnEvent(!1),this._firstReConn=!1,this.debug&&console.log("Reconnecting to ",this.sock.url),setTimeout(()=>{this.pendingOnOpen=[],this._websockSetup(this.sock.url)},this._reconnectTime))}_onWebsockOpen(){this.debug&&console.log("Connected to ",this.sock.url),this._sendConnEvent(!0),this.sock.onclose=this._websockReconnect.bind(this),this.sock.onmessage=e=>{this._onWebsockRx&&this._onWebsockRx.call(this,e.data)},this._firstConn=!1,this._firstReConn=!0,this.pendingOnOpen.forEach(e=>e()),this.pendingOnOpen.length=0}toString(){let e="";return e+=(this.sock,this.sock.url.toString()),e}write(e){return this.sock&&this.sock.readyState!=this.sock.CONNECTING?this.sock.readyState==this.sock.OPEN&&(this.sock.send(e+"\n"),!0):(this.pendingOnOpen.push(()=>{this.sock.send(e+"\n")}),!0)}setReadCallback(e){e&&"[object Function]"==={}.toString.call(e)&&(this._onWebsockRx=e)}addConnectionListener(e){this.connListeners.push(e)}removeConnectionListener(e){let t=this.connListeners.indexOf(e);return t>=0&&(this.connListeners.splice(t,1),!0)}close(){this.sock&&(this.sock.readyState==this.sock.CONNECTING?this.pendingOnOpen.push(()=>{this.sock.send('{"alive": false}\n'),this.sock.onclose=null,this.sock.close()}):this.sock.readyState==this.sock.OPEN&&(this.sock.send('{"alive": false}\n'),this.sock.onclose=null,this.sock.close()))}}class g{constructor(e,t){if(this.id=s(8),this.action=null,this.inResponseTo=null,this.agentID=null,this.agentIDs=null,this.agentTypes=null,this.service=null,this.services=null,this.answer=null,this.message=null,this.relay=null,this.creds=null,this.auth=null,this.name=null,e&&"string"==typeof e)try{const s=JSON.parse(e,p);s.message&&(s.message=v.fromJSON(s.message)),s.agentID&&(s.agentID=_.fromJSON(s.agentID,t)),s.agentIDs&&(s.agentIDs=s.agentIDs.map(e=>_.fromJSON(e,t))),Object.assign(this,s)}catch(e){throw new Error("Invalid JSON string: "+e.message)}}static createSend(e,t=!1){if(!(e instanceof v))throw new Error("Invalid message type");const s=new g;return s.action=d.SEND,s.relay=t,s.message=e,s}static createWantsMessagesFor(e){if(!Array.isArray(e)||0===e.length)throw new Error("agentIDNames must be a non-empty array");const t=new g;return t.action=d.WANTS_MESSAGES_FOR,t.agentIDs=e,t}static createAgents(){const e=new g;return e.action=d.AGENTS,e.id=s(8),e}static createContainsAgent(e){if(!(e instanceof _))throw new Error("agentID must be an instance of AgentID");const t=new g;return t.action=d.CONTAINS_AGENT,t.id=s(8),t.agentID=e,t}static createAgentForService(e){if("string"!=typeof e||0===e.length)throw new Error("service must be a non-empty string");const t=new g;return t.action=d.AGENT_FOR_SERVICE,t.id=s(8),t.service=e,t}static createAgentsForService(e){if("string"!=typeof e||0===e.length)throw new Error("service must be a non-empty string");const t=new g;return t.action=d.AGENTS_FOR_SERVICE,t.id=s(8),t.service=e,t}toJSON(){if(!this.action&&!this.id)throw new Error("Neither action nor id is set. Cannot serialize JSONMessage.");const e={};return this.id&&(e.id=this.id),this.action&&(e.action=this.action),this.inResponseTo&&(e.inResponseTo=this.inResponseTo),this.agentID&&(e.agentID=this.agentID.toJSON()),this.agentIDs&&(e.agentIDs=this.agentIDs.map(e=>e.toJSON()),0===e.agentIDs.length&&delete e.agentIDs),this.service&&(e.service=this.service),this.services&&(e.services=this.services,0===e.services.length&&delete e.services),this.answer&&(e.answer=this.answer),this.message&&(e.message=this.message),this.relay&&(e.relay=this.relay),this.creds&&(e.creds=this.creds),this.auth&&(e.auth=this.auth),this.name&&(e.name=this.name),JSON.stringify(e)}toString(){return this.toJSON()}}const d={AGENTS:"agents",CONTAINS_AGENT:"containsAgent",AGENT_FOR_SERVICE:"agentForService",AGENTS_FOR_SERVICE:"agentsForService",SEND:"send",WANTS_MESSAGES_FOR:"wantsMessagesFor"};function p(e,t){if(null===t)return null;if("object"==typeof t&&"clazz"in t&&t.clazz.startsWith("[")&&2==t.clazz.length&&"data"in t){let e=function(e,t,s=!0){let a=function(e){if(n||i)return window.atob(e);if(o||r)return Buffer.from(e,"base64").toString("binary")}(e),l=a.length,c=new Uint8Array(l);for(var h=0;h<l;h++)c[h]=a.charCodeAt(h);let u=[],g=new DataView(c.buffer);switch(t){case"[B":for(h=0;h<l;h++)u.push(g.getUint8(h));break;case"[S":for(h=0;h<l;h+=2)u.push(g.getInt16(h,s));break;case"[I":for(h=0;h<l;h+=4)u.push(g.getInt32(h,s));break;case"[J":for(h=0;h<l;h+=8)u.push(g.getBigInt64(h,s));break;case"[F":for(h=0;h<l;h+=4)u.push(g.getFloat32(h,s));break;case"[D":for(h=0;h<l;h+=8)u.push(g.getFloat64(h,s));break;default:return}return u}(t.data,t.clazz);e&&(t=e)}return t}const f={timeout:1e4,keepAlive:!0,queueSize:128,returnNullOnFailedResponse:!0};let R,m={};class S{constructor(e={}){for(var t in f)null!=e[t]&&""!==e[t]||(e[t]=f[t]);var n=R;n.hostname=e.hostname,n.port=e.port,n.pathname=e.pathname;let r=this._getGWCache(n);if(r)return r;this._timeout=e.timeout,this._keepAlive=e.keepAlive,this._queueSize=e.queueSize,this._returnNullOnFailedResponse=e.returnNullOnFailedResponse,this._cancelPendingOnDisconnect=e.cancelPendingOnDisconnect,this.pending={},this.subscriptions={},this.listeners={},this.eventListeners={},this.queue=[],this.connected=!1,this.debug=!1,this.aid=new _("gateway-"+s(4)),this.connector=this._createConnector(n),this._addGWCache(this)}_sendEvent(e,t){Array.isArray(this.eventListeners[e])&&this.eventListeners[e].forEach(e=>{if(e&&"[object Function]"==={}.toString.call(e))try{e(t)}catch(e){console.warn("Error in event listener : "+e)}})}_sendReceivers(e){for(var t in this.listeners)try{if(this.listeners[t]&&this.listeners[t](e))return!0}catch(e){console.warn("Error in listener : "+e)}return!1}_onMsgRx(e){var t;this.debug&&console.log("< "+e),this._sendEvent("rx",e);try{t=new g(e,this)}catch(e){return}if(this._sendEvent("rxp",t),t.id&&t.id in this.pending)this.pending[t.id](t),delete this.pending[t.id];else if(t.action==d.SEND){const e=t.message;if(!e)return;this._sendEvent("rxmsg",e),(e.recipient.toJSON()==this.aid.toJSON()||this.subscriptions[e.recipient.toJSON()])&&(this._sendEvent("message",e),this._sendReceivers(e)||(this.queue.length>=this._queueSize&&this.queue.shift(),this.queue.push(e)))}else{let e=new g;switch(e.id=t.id,e.inResponseTo=t.action,t.action){case"agents":e.agentIDs=[this.aid];break;case"containsAgent":e.answer=t.agentID.toJSON()==this.aid.toJSON();break;case"services":e.services=[];break;case"agentForService":e.agentID="";break;case"agentsForService":e.agentIDs=[];break;default:e=void 0}e&&this._msgTx(e)}}_msgTx(e){const t=e.toJSON();return this.debug&&console.log("> "+t),this._sendEvent("tx",t),this.connector.write(t)}_msgTxRx(e,t=this._timeout){return e.id=s(8),new Promise(s=>{let n;t>=0&&(n=setTimeout(()=>{delete this.pending[e.id],this.debug&&console.log("Receive Timeout : "+JSON.stringify(e)),s(null)},t)),this.pending[e.id]=e=>{n&&clearTimeout(n),s(e)},this._msgTx.call(this,e)||(n&&clearTimeout(n),delete this.pending[e.id],this.debug&&console.log("Transmit Failure : "+JSON.stringify(e)),s(null))})}_createConnector(e){let t;if(e.protocol.startsWith("ws"))t=new u({hostname:e.hostname,port:parseInt(e.port),pathname:e.pathname,keepAlive:this._keepAlive,debug:this.debug});else{if(!e.protocol.startsWith("tcp"))return null;t=new h({hostname:e.hostname,port:parseInt(e.port),keepAlive:this._keepAlive,debug:this.debug})}return t.setReadCallback(this._onMsgRx.bind(this)),t.addConnectionListener(e=>{this.connected=!!e,1==e?(this.flush(),this.connector.write('{"alive": true}'),this._update_watch()):this._cancelPendingOnDisconnect&&(this._sendReceivers(null),this.flush()),this._sendEvent("conn",e)}),t}_isConstructor(e){try{return new new Proxy(e,{construct:()=>({})}),!0}catch(e){return!1}}_matchMessage(e,t){if("string"==typeof e||e instanceof String)return"inReplyTo"in t&&t.inReplyTo==e;if(Object.prototype.hasOwnProperty.call(e,"msgID"))return"inReplyTo"in t&&t.inReplyTo==e.msgID;if("Message"==e.__proto__.name||"Message"==e.__proto__.__proto__.name)return e.__clazz__==t.__clazz__;if("function"!=typeof e||this._isConstructor(e))return t instanceof e;try{return e(t)}catch(e){return console.warn("Error in filter : "+e),!1}}_getMessageFromQueue(e){if(!this.queue.length)return;if(!e)return this.queue.shift();let t=this.queue.find(t=>this._matchMessage(e,t));return t&&this.queue.splice(this.queue.indexOf(t),1),t}_getGWCache(e){if(!m.fjage||!m.fjage.gateways)return null;var t=m.fjage.gateways.filter(t=>t.connector.url.toString()==e.toString());return t.length?t[0]:null}_addGWCache(e){m.fjage&&m.fjage.gateways&&m.fjage.gateways.push(e)}_removeGWCache(e){if(m.fjage&&m.fjage.gateways){var t=m.fjage.gateways.indexOf(e);null!=t&&m.fjage.gateways.splice(t,1)}}_update_watch(){let e=Object.keys(this.subscriptions);e.push(this.aid.toJSON());const t=g.createWantsMessagesFor(e.map(e=>_.fromJSON(e)));this._msgTx(t)}addEventListener(e,t){Array.isArray(this.eventListeners[e])||(this.eventListeners[e]=[]),this.eventListeners[e].push(t)}removeEventListener(e,t){if(!this.eventListeners[e])return;let s=this.eventListeners[e].indexOf(t);s>=0&&this.eventListeners[e].splice(s,1)}addMessageListener(e){this.addEventListener("message",e)}removeMessageListener(e){this.removeEventListener("message",e)}addConnListener(e){this.addEventListener("conn",e)}removeConnListener(e){this.removeEventListener("conn",e)}getAgentID(){return this.aid}agent(e){return new _(e,!1,this)}topic(e,t){return"string"==typeof e||e instanceof String?new _(e,!0,this):e instanceof _?e.isTopic()?e:new _(e.getName()+(t?"__"+t:"")+"__ntf",!0,this):void 0}subscribe(e){return e.isTopic()||(e=new _(e.getName()+"__ntf",!0,this)),this.subscriptions[e.toJSON()]=!0,this._update_watch(),!0}unsubscribe(e){e.isTopic()||(e=new _(e.getName()+"__ntf",!0,this)),delete this.subscriptions[e.toJSON()],this._update_watch()}async agents(e=this._timeout){let t=g.createAgents(),s=await this._msgTxRx(t,e);if(!s||!Array.isArray(s.agentIDs))throw new Error("Unable to get agents");return s.agentIDs}async containsAgent(e,t=this._timeout){let s=g.createContainsAgent(e instanceof _?e:new _(e)),n=await this._msgTxRx(s,t);if(!n){if(this._returnNullOnFailedResponse)return null;throw new Error("Unable to check if agent exists")}return!!n.answer}async agentForService(e,t=this._timeout){let s=g.createAgentForService(e),n=await this._msgTxRx(s,t);if(!n){if(this._returnNullOnFailedResponse)return null;throw new Error("Unable to get agent for service")}return n.agentID}async agentsForService(e,t=this._timeout){let s=g.createAgentsForService(e),n=await this._msgTxRx(s,t);if(!n){if(this._returnNullOnFailedResponse)return null;throw new Error("Unable to get agents for service")}return n.agentIDs||[]}send(e){e.sender=this.aid,this._sendEvent("txmsg",e);const t=g.createSend(e,!0);return!!this._msgTx(t)}flush(){this.queue.length=0}async request(e,t=this._timeout){return this.send(e),this.receive(e,t)}async receive(e,t=0){return new Promise(n=>{let r=this._getMessageFromQueue.call(this,e);if(r)return void n(r);if(0==t)return this.debug&&console.log("Receive Timeout : "+e),void n();let i,o=s(8);t>0&&(i=setTimeout(()=>{this.listeners[o]&&delete this.listeners[o],this.debug&&console.log("Receive Timeout : "+e),n()},t)),this.listeners[o]=t=>!(t&&!this._matchMessage(e,t))&&(i&&clearTimeout(i),this.listeners[o]&&delete this.listeners[o],n(t),!0)})}close(){this.connector.close(),this._removeGWCache(this)}}class _{constructor(e,t=!1,s){this.name=e,this.topic=t,this.owner=s,this._timeout=s?s._timeout:1e4}getName(){return this.name}isTopic(){return this.topic}send(e){if(e.recipient=this,!this.owner)throw new Error("Unowned AgentID cannot send messages");this.owner.send(e)}async request(e,t=this._timeout){if(e.recipient=this,this.owner)return this.owner.request(e,t);throw new Error("Unowned AgentID cannot send messages")}toString(){return this.toJSON()+(this.owner&&this.owner.connector?` on ${this.owner.connector.url}`:"")}toJSON(){return(this.topic?"#":"")+this.name}static fromJSON(e,t){if("string"!=typeof e)throw new Error("Invalid JSON for AgentID");return(e=e.trim()).startsWith("#")?new _(e.substring(1),!0,t):new _(e,!1,t)}async set(e,s,n=-1,r=this._timeout){if(!e)return null;let i=new w;if(i.recipient=this,Array.isArray(e)){if(e.length!=s.length)throw new Error(`Parameters and values arrays must have the same length: ${e.length} != ${s.length}`);const t=e.slice(),n=s.slice();i.param=t.shift(),i.value=n.shift(),i.requests=t.map((e,t)=>({param:e,value:n[t]}))}else i.param=e,i.value=s;i.index=Number.isInteger(n)?n:-1;const o=await this.owner.request(i,r);var a=Array.isArray(e)?new Array(e.length).fill(null):null;if(!o||o.perf!=t.INFORM||!o.param){if(this.owner._returnNullOnFailedResponse)return a;throw new Error(`Unable to set ${this.name}.${e} to ${s}`)}if(Array.isArray(e)){o.values||(o.values={}),o.param&&(o.values[o.param]=o.value);const t=Object.keys(o.values);return e.map(e=>{e.includes(".")&&(e=e.split(".").pop());let s=t.find(t=>(t.includes(".")?t.split(".").pop():t)==e);return s?o.values[s]:void 0})}return o.value}async get(e,s=-1,n=this._timeout){let r=new w;if(r.recipient=this,e)if(Array.isArray(e)){const t=e.slice();r.param=t.shift(),r.requests=t.map(e=>({param:e}))}else r.param=e;r.index=Number.isInteger(s)?s:-1;const i=await this.owner.request(r,n);var o=Array.isArray(e)?new Array(e.length).fill(null):null;if(!i||i.perf!=t.INFORM||!i.param){if(this.owner._returnNullOnFailedResponse)return o;throw new Error(`Unable to get ${this.name}.${e}`)}if(e){if(Array.isArray(e)){i.values||(i.values={}),i.param&&(i.values[i.param]=i.value);const t=Object.keys(i.values);return e.map(e=>{e.includes(".")&&(e=e.split(".").pop());let s=t.find(t=>(t.includes(".")?t.split(".").pop():t)==e);return s?i.values[s]:void 0})}return i.value}return i.values||(i.values={}),i.param&&(i.values[i.param]=i.value),i.values}}class v{constructor(e,n=t.INFORM){this.__clazz__="org.arl.fjage.Message",this.msgID=s(8),this.perf=n,this.sender=null,this.recipient=e?e.sender:null,this.inReplyTo=e?e.msgID:null}toString(){let e=this.perf?this.perf.toString():"MESSAGE";return"org.arl.fjage.Message"==this.__clazz__?e:e+": "+this.__clazz__.replace(/^.*\./,"")}toJSON(){let e={};for(let t in this)t.startsWith("_")||(e[t]=this[t]);return{clazz:this.__clazz__,data:e}}static fromJSON(e){if(!("clazz"in e)||!("data"in e))throw new Error(`Invalid Object for Message : ${e}`);let t=e.clazz,s=t.replace(/^.*\./,""),n=N[s]?new N[s]:new v;for(var r in n.__clazz__=t,e.data)"sender"===r||"recipient"===r?e.data[r]&&"string"==typeof e.data[r]&&(n[r]=_.fromJSON(e.data[r])):n[r]=e.data[r];return n}}function N(e,s=v){let n=e.replace(/^.*\./,"");if(N[n])return N[n];let r=class extends s{constructor(s){if(super(),this.__clazz__=e,s){const e=Object.keys(s);for(let t of e)this[t]=s[t]}e.endsWith("Req")&&(this.perf=t.REQUEST)}};return r.__clazz__=e,N[n]=r,r}const w=N("org.arl.fjage.param.ParameterReq");N("org.arl.fjage.param.ParameterRsp");const A={SHELL:"org.arl.fjage.shell.Services.SHELL"};n||i?(m=window,Object.assign(f,{hostname:m.location.hostname,port:m.location.port,pathname:"/ws/"}),R=new URL("ws://localhost"),void 0===m.fjage&&(m.fjage={}),void 0===m.fjage.gateways&&(m.fjage.gateways=[])):(o||r)&&(m=global,Object.assign(f,{hostname:"localhost",port:"1100",pathname:""}),R=new URL("tcp://localhost"));const y=N("org.arl.unet.DatagramReq"),E=N("org.arl.unet.DatagramNtf"),O=N("org.arl.unet.phy.TxFrameReq",y),b=N("org.arl.unet.phy.RxFrameNtf",E),k=N("org.arl.unet.bb.BasebandSignal");Object.assign(A,{NODE_INFO:"org.arl.unet.Services.NODE_INFO",ADDRESS_RESOLUTION:"org.arl.unet.Services.ADDRESS_RESOLUTION",DATAGRAM:"org.arl.unet.Services.DATAGRAM",PHYSICAL:"org.arl.unet.Services.PHYSICAL",RANGING:"org.arl.unet.Services.RANGING",BASEBAND:"org.arl.unet.Services.BASEBAND",LINK:"org.arl.unet.Services.LINK",MAC:"org.arl.unet.Services.MAC",ROUTING:"org.arl.unet.Services.ROUTING",ROUTE_MAINTENANCE:"org.arl.unet.Services.ROUTE_MAINTENANCE",TRANSPORT:"org.arl.unet.Services.TRANSPORT",REMOTE:"org.arl.unet.Services.REMOTE",STATE_MANAGER:"org.arl.unet.Services.STATE_MANAGER",DEVICE_INFO:"org.arl.unet.Services.DEVICE_INFO",DOA:"org.arl.unet.Services.DOA",SCHEDULER:"org.arl.unet.Services.SCHEDULER"});let T={DATA:0,RANGING:1,LINK:2,REMOTE:3,MAC:4,ROUTING:5,TRANSPORT:6,ROUTE_MAINTENANCE:7,LINK2:8,USER:32,MAX:63},F={TestReportNtf:N("org.arl.unet.TestReportNtf"),AbnormalTerminationNtf:N("org.arl.unet.AbnormalTerminationNtf"),CapabilityListRsp:N("org.arl.unet.CapabilityListRsp"),CapabilityReq:N("org.arl.unet.CapabilityReq"),ClearReq:N("org.arl.unet.ClearReq"),DatagramCancelReq:N("org.arl.unet.DatagramCancelReq"),DatagramDeliveryNtf:N("org.arl.unet.DatagramDeliveryNtf"),DatagramFailureNtf:N("org.arl.unet.DatagramFailureNtf"),DatagramNtf:N("org.arl.unet.DatagramNtf"),DatagramProgressNtf:N("org.arl.unet.DatagramProgressNtf"),DatagramReq:N("org.arl.unet.DatagramReq"),ParamChangeNtf:N("org.arl.unet.ParamChangeNtf"),RefuseRsp:N("org.arl.unet.RefuseRsp"),FailureNtf:N("org.arl.unet.FailureNtf"),DatagramTraceReq:N("org.arl.unet.net.DatagramTraceReq"),RouteDiscoveryReq:N("org.arl.unet.net.RouteDiscoveryReq"),RouteTraceReq:N("org.arl.unet.net.RouteTraceReq"),RouteDiscoveryNtf:N("org.arl.unet.net.RouteDiscoveryNtf"),RouteTraceNtf:N("org.arl.unet.net.RouteTraceNtf"),FecDecodeReq:N("org.arl.unet.phy.FecDecodeReq"),RxSWiG1FrameNtf:N("org.arl.unet.phy.RxSWiG1FrameNtf",b),TxSWiG1FrameReq:N("org.arl.unet.phy.TxSWiG1FrameReq",O),RxJanusFrameNtf:N("org.arl.unet.phy.RxJanusFrameNtf",b),TxJanusFrameReq:N("org.arl.unet.phy.TxJanusFrameReq",O),BadFrameNtf:N("org.arl.unet.phy.BadFrameNtf"),BadRangeNtf:N("org.arl.unet.phy.BadRangeNtf"),ClearSyncReq:N("org.arl.unet.phy.ClearSyncReq"),CollisionNtf:N("org.arl.unet.phy.CollisionNtf"),RxFrameNtf:N("org.arl.unet.phy.RxFrameNtf",E),RxFrameStartNtf:N("org.arl.unet.phy.RxFrameStartNtf"),SyncInfoReq:N("org.arl.unet.phy.SyncInfoReq"),SyncInfoRsp:N("org.arl.unet.phy.SyncInfoRsp"),TxFrameNtf:N("org.arl.unet.phy.TxFrameNtf"),TxFrameReq:N("org.arl.unet.phy.TxFrameReq",y),TxFrameStartNtf:N("org.arl.unet.phy.TxFrameStartNtf"),TxRawFrameReq:N("org.arl.unet.phy.TxRawFrameReq"),AddressAllocReq:N("org.arl.unet.addr.AddressAllocReq"),AddressAllocRsp:N("org.arl.unet.addr.AddressAllocRsp"),AddressResolutionReq:N("org.arl.unet.addr.AddressResolutionReq"),AddressResolutionRsp:N("org.arl.unet.addr.AddressResolutionRsp"),BasebandSignal:N("org.arl.unet.bb.BasebandSignal"),RecordBasebandSignalReq:N("org.arl.unet.bb.RecordBasebandSignalReq"),RxBasebandSignalNtf:N("org.arl.unet.bb.RxBasebandSignalNtf",k),TxBasebandSignalReq:N("org.arl.unet.bb.TxBasebandSignalReq",k),LinkStatusNtf:N("org.arl.unet.link.LinkStatusNtf"),RangeNtf:N("org.arl.unet.localization.RangeNtf"),RangeReq:N("org.arl.unet.localization.RangeReq"),BeaconReq:N("org.arl.unet.localization.BeaconReq"),RespondReq:N("org.arl.unet.localization.RespondReq"),InterrogationNtf:N("org.arl.unet.localization.InterrogationNtf"),ReservationAcceptReq:N("org.arl.unet.mac.ReservationAcceptReq"),ReservationCancelReq:N("org.arl.unet.mac.ReservationCancelReq"),ReservationReq:N("org.arl.unet.mac.ReservationReq"),ReservationRsp:N("org.arl.unet.mac.ReservationRsp"),ReservationStatusNtf:N("org.arl.unet.mac.ReservationStatusNtf"),RxAckNtf:N("org.arl.unet.mac.RxAckNtf"),TxAckReq:N("org.arl.unet.mac.TxAckReq"),RemoteExecReq:N("org.arl.unet.remote.RemoteExecReq"),RemoteFailureNtf:N("org.arl.unet.remote.RemoteFailureNtf"),RemoteFileGetReq:N("org.arl.unet.remote.RemoteFileGetReq"),RemoteFileNtf:N("org.arl.unet.remote.RemoteFileNtf"),RemoteFilePutReq:N("org.arl.unet.remote.RemoteFilePutReq"),RemoteSuccessNtf:N("org.arl.unet.remote.RemoteSuccessNtf"),RemoteTextNtf:N("org.arl.unet.remote.RemoteTextNtf"),RemoteTextReq:N("org.arl.unet.remote.RemoteTextReq"),AddScheduledSleepReq:N("org.arl.unet.scheduler.AddScheduledSleepReq"),GetSleepScheduleReq:N("org.arl.unet.scheduler.GetSleepScheduleReq"),RemoveScheduledSleepReq:N("org.arl.unet.scheduler.RemoveScheduledSleepReq"),SleepScheduleRsp:N("org.arl.unet.scheduler.SleepScheduleRsp"),WakeFromSleepNtf:N("org.arl.unet.scheduler.WakeFromSleepNtf"),ClearStateReq:N("org.arl.unet.state.ClearStateReq"),SaveStateReq:N("org.arl.unet.state.SaveStateReq")};function D(e){let t=e*Math.PI/180,s=111132.92-559.82*Math.cos(2*t)+1.175*Math.cos(4*t)-.0023*Math.cos(6*t);return[111412.84*Math.cos(t)-93.5*Math.cos(3*t)+.118*Math.cos(5*t),s]}const I=F.AddressResolutionReq,C=F.DatagramReq,q=F.DatagramNtf,x=F.RxFrameNtf;e.AgentID=_,e.Gateway=S,e.Message=v,e.MessageClass=N,e.Performative=t,e.Protocol=T,e.Services=A,e.UnetMessages=F,e.UnetSocket=class{constructor(e,t,s=""){return(async()=>{this.gw=new S({hostname:e,port:t,path:s}),this.localProtocol=-1,this.remoteAddress=-1,this.remoteProtocol=T.DATA,this.timeout=0,this.provider=null;return(await this.gw.agentsForService(A.DATAGRAM)).forEach(e=>{this.gw.subscribe(this.gw.topic(e))}),this})()}close(){this.gw.close(),this.gw=null}isClosed(){return null==this.gw}bind(e){return(e==T.DATA||e>=T.USER&&e<=T.MAX)&&(this.localProtocol=e,!0)}unbind(){this.localProtocol=-1}isBound(){return this.localProtocol>=0}connect(e,t){return e>=0&&(t==T.DATA||t>=T.USER&&t<=T.MAX)&&(this.remoteAddress=e,this.remoteProtocol=t,!0)}disconnect(){this.remoteAddress=-1,this.remoteProtocol=0}isConnected(){return this.remoteAddress>=0}async getLocalAddress(){if(null==this.gw)return-1;const e=await this.gw.agentForService(A.NODE_INFO);if(null==e)return-1;const t=await e.get("address");return null!=t?t:-1}getLocalProtocol(){return this.localProtocol}getRemoteAddress(){return this.remoteAddress}getRemoteProtocol(){return this.remoteProtocol}setTimeout(e){e<0&&(e=0),this.timeout=e}getTimeout(){return this.timeout}async send(e,s=this.remoteAddress,n=this.remoteProtocol){if(s<0||null==this.gw)return!1;var r;if(Array.isArray(e))(r=new C).data=e,r.to=s,r.protocol=n;else{if(!(e instanceof C))return!1;r=e}let i=r.protocol;if(i!=T.DATA&&(i<T.USER||i>T.MAX))return!1;if(null==r.recipient){if(null==this.provider&&(this.provider=await this.gw.agentForService(A.TRANSPORT)),null==this.provider&&(this.provider=await this.gw.agentForService(A.ROUTING)),null==this.provider&&(this.provider=await this.gw.agentForService(A.LINK)),null==this.provider&&(this.provider=await this.gw.agentForService(A.PHYSICAL)),null==this.provider&&(this.provider=await this.gw.agentForService(A.DATAGRAM)),null==this.provider)return!1;r.recipient=this.provider}const o=await this.gw.request(r,1e3);return null!=o&&o.perf==t.AGREE}async receive(){return null==this.gw?null:await this.gw.receive(e=>{if(e.__clazz__!=q.__clazz__&&e.__clazz__!=x.__clazz__)return!1;let t=e.protocol;return(t==T.DATA||t>=T.USER)&&(this.localProtocol<0||this.localProtocol==t)},this.timeout)}getGateway(){return this.gw}async agentForService(e){return null==this.gw?null:await this.gw.agentForService(e)}async agentsForService(e){return null==this.gw?null:await this.gw.agentsForService(e)}agent(e){return null==this.gw?null:this.gw.agent(e)}async host(e){const t=await this.agentForService(A.ADDRESS_RESOLUTION);if(null==t)return null;const s=new I(e);s.name=e,s.recipient=t;const n=await this.gw.request(s,1e3);return null!=n&&Object.prototype.hasOwnProperty.call(n,"address")?n.address:null}},e.toGps=function(e,t,s){let n=[],[r,i]=D(e[0]);return n[1]=t/r+e[1],n[0]=s/i+e[0],n},e.toLocal=function(e,t,s){let n=[],[r,i]=D(e[0]);return n[0]=(s-e[1])*r,n[1]=(t-e[0])*i,n}});
//# sourceMappingURL=unetjs.min.js.map
